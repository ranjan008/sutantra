<!DOCTYPE html>
<html>
<head>
    <title>Stream Discovery Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a2e; color: white; }
        .test-section { border: 1px solid #4fc3f7; margin: 15px 0; padding: 15px; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; background: #4fc3f7; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #29b6f6; }
        .log { background: #0f0f23; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <h1>üß™ Stream Discovery Test</h1>
    
    <div class="test-section">
        <h2>Test Stream Discovery</h2>
        <button onclick="testViewerStreamDiscovery()">Test Viewer Stream Discovery</button>
        <button onclick="testStreamerCreateStream()">Test Streamer Create Stream</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>Test Results:</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testViewerStreamDiscovery() {
            log('üîç Testing viewer stream discovery on port 8081...', 'info');
            
            const ws = new WebSocket('ws://localhost:8081/ws');
            
            ws.onopen = function() {
                log('‚úÖ Connected to viewer WebSocket', 'success');
                
                // Send handshake
                const handshake = { type: 'handshake', data: { client_type: 'test' } };
                log('üì§ Sending handshake...', 'info');
                ws.send(JSON.stringify(handshake));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                log(`üì• Received: ${message.type}`, 'info');
                
                if (message.type === 'handshakeResponse') {
                    log('ü§ù Handshake successful, requesting stream list...', 'success');
                    
                    const streamRequest = { type: 'requestStreamList', data: {} };
                    ws.send(JSON.stringify(streamRequest));
                } else if (message.type === 'streamList') {
                    const streams = message.data?.streams || [];
                    log(`üì∫ Stream list received: ${streams.length} streams`, 'success');
                    
                    if (streams.length > 0) {
                        streams.forEach((stream, i) => {
                            log(`  Stream ${i + 1}: "${stream.title}" (${stream.stream_id})`, 'info');
                        });
                    } else {
                        log('  No streams found (expected if no active streams)', 'info');
                    }
                    
                    ws.close();
                }
            };
            
            ws.onerror = function(error) {
                log(`‚ùå WebSocket error: ${error}`, 'error');
            };
        }

        function testStreamerCreateStream() {
            log('üé¨ Testing streamer create stream on port 8080...', 'info');
            
            const ws = new WebSocket('ws://localhost:8080/ws');
            
            ws.onopen = function() {
                log('‚úÖ Connected to streamer WebSocket', 'success');
                
                // Send handshake
                const handshake = { type: 'handshake', data: { client_type: 'test' } };
                log('üì§ Sending handshake...', 'info');
                ws.send(JSON.stringify(handshake));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                log(`üì• Received: ${message.type}`, 'info');
                
                if (message.type === 'handshakeResponse') {
                    log('ü§ù Handshake successful, creating stream...', 'success');
                    
                    const createStream = {
                        type: 'createStream',
                        data: {
                            title: 'Test Stream',
                            description: 'Test stream for discovery'
                        }
                    };
                    ws.send(JSON.stringify(createStream));
                } else if (message.type === 'createStreamResponse') {
                    if (message.data?.success) {
                        log(`‚úÖ Stream created: ${message.data.stream_id}`, 'success');
                        log('üí° Now test viewer discovery to see if it appears!', 'info');
                    } else {
                        log(`‚ùå Stream creation failed: ${message.data?.message}`, 'error');
                    }
                    ws.close();
                }
            };
            
            ws.onerror = function(error) {
                log(`‚ùå WebSocket error: ${error}`, 'error');
            };
        }

        log('üöÄ Stream Discovery Test Ready', 'success');
        log('üìã Instructions:', 'info');
        log('1. Click "Test Viewer Stream Discovery" to see current streams', 'info');
        log('2. Click "Test Streamer Create Stream" to create a test stream', 'info');
        log('3. Click "Test Viewer Stream Discovery" again to see the new stream', 'info');
    </script>
</body>
</html>

